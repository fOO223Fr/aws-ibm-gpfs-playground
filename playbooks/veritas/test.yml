- name: Check if oc is available in PATH
  ansible.builtin.shell: which oc
  register: oc_in_path
  failed_when: false
  changed_when: false
  tags: test

- name: Check if already logged in to OCP
  ansible.builtin.shell: oc whoami
  register: oc_logged_in
  failed_when: false
  changed_when: false
  when: oc_in_path.rc == 0
  tags: test

- name: Set OC binary and kubeconfig based on login status
  ansible.builtin.set_fact:
    use_oc_bin: "{{ 'oc' if oc_in_path.rc == 0 else oc_bin }}"
    kubeconfig_param: "{{ (lookup('env', 'HOME') + '/.kube/config') if (oc_logged_in.rc | default(1)) == 0 else kubeconfig }}"
  tags: test

- name: Get InfoScaleCluster
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig_param }}"
    api_version: infoscale.veritas.com/v1
    kind: InfoScaleCluster
    namespace: infoscale-vtas
    name: infoscalecluster-dev
  register: isc_info
  tags: test

- name: Get InfoScaleCluster (verify)
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig_param }}"
    api_version: infoscale.veritas.com/v1
    kind: InfoScaleCluster
    namespace: infoscale-vtas
    name: infoscalecluster-dev
  register: isc_info

- name: Assert InfoScaleCluster is Running, Healthy
  ansible.builtin.assert:
    that:
      - isc_info.resources | length > 0
      - (isc_info.resources[0].status.phase       | default('')) == "Running"
      - (isc_info.resources[0].status.clusterState | default('')) == "Healthy"
      - isc_info.resources[0].status.diskgroups is defined
      - (isc_info.resources[0].status.diskgroups | default([]) | length) > 0
    success_msg: >-
      InfoScaleCluster is Running, Healthy, and has {{ isc_info.resources[0].status.diskgroups | default([]) | length }} diskgroup(s)
    fail_msg: >-
      InfoScaleCluster check failed:
        phase={{ isc_info.resources[0].status.phase | default('MISSING') }},
        clusterState={{ isc_info.resources[0].status.clusterState | default('MISSING') }},
        diskgroups={{ isc_info.resources[0].status.diskgroups | default([]) | length }}
  tags: test

- name: Deploy PVC + Deployment workload
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_param }}"
    state: present
    definition: "{{ lookup('file', '../../templates/veritas/test-workload.yaml') }}"
    namespace: default
  tags: test

- name: Wait for infoscale-claim PVC to be Bound
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig_param }}"
    api_version: v1
    kind: PersistentVolumeClaim
    namespace: default
    name: infoscale-claim
  register: pvc_info
  until: pvc_info.resources[0].status.phase == "Bound"
  retries: 10
  delay: 6
  tags: test

- name: Wait for containertools Pod to be Running
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig_param }}"
    api_version: v1
    kind: Pod
    namespace: default
    label_selectors:
      - app=containertools
  register: pod_info
  until: >
    (pod_info.resources | length > 0)
    and (pod_info.resources[0].status.phase == "Running")
  retries: 10
  delay: 6
  tags: test

- name: Delete containertools Deployment
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_param }}"
    state: absent
    api_version: apps/v1
    kind: Deployment
    namespace: default
    name: containertools
  tags: test

- name: Delete infoscale-claim PVC
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_param }}"
    state: absent
    api_version: v1
    kind: PersistentVolumeClaim
    namespace: default
    name: infoscale-claim
  tags: test
