---
# Performance test tasks for Veritas InfoScale VM cloning
# Tests PVC provisioning at scale to verify version 9.1 improvements

- name: Check if oc is available in PATH
  ansible.builtin.shell: which oc
  register: oc_in_path
  failed_when: false
  changed_when: false
  tags: perf-test

- name: Check if already logged in to OCP
  ansible.builtin.shell: oc whoami
  register: oc_logged_in
  failed_when: false
  changed_when: false
  when: oc_in_path.rc == 0
  tags: perf-test

- name: Set OC binary and kubeconfig based on login status
  ansible.builtin.set_fact:
    use_oc_bin: "{{ 'oc' if oc_in_path.rc == 0 else oc_bin }}"
    use_kubeconfig: "{{ '' if (oc_logged_in.rc | default(1)) == 0 else kubeconfig }}"
    kubeconfig_display: "{{ '~/.kube/config (current session)' if (oc_logged_in.rc | default(1)) == 0 else kubeconfig }}"
    kubeconfig_param: "{{ (lookup('env', 'HOME') + '/.kube/config') if (oc_logged_in.rc | default(1)) == 0 else kubeconfig }}"
    virtctl_bin_path: "{{ 'virtctl' if oc_in_path.rc == 0 else (virtctl_bin | default('virtctl')) }}"
  tags: perf-test

- name: Set default variables for performance test
  ansible.builtin.set_fact:
    num_vms: "{{ num_vms | default(10) }}"
    clean_results: "{{ clean_results | default(false) | bool }}"
    results_dir: "{{ playbook_dir }}/../../results-veritas-9.1"
  tags: perf-test

- name: Create results directory
  ansible.builtin.file:
    path: "{{ results_dir }}"
    state: directory
    mode: '0755'
  tags: perf-test

- name: Clean results directory if clean_results flag is set
  ansible.builtin.shell: rm -f {{ results_dir }}/*.csv {{ results_dir }}/*.txt
  when: clean_results | bool
  tags: perf-test

- name: Display clean results message
  ansible.builtin.debug:
    msg: "üóëÔ∏è  Results directory cleaned - starting fresh"
  when: clean_results | bool
  tags: perf-test

- name: Display cluster information banner
  ansible.builtin.debug:
    msg:
      - "========================================================================"
      - "           VERITAS INFOSCALE PERFORMANCE TEST"
      - "           OCPNAS-312 Concurrency Validation"
      - "========================================================================"
      - "Kubeconfig:      {{ kubeconfig_display }}"
      - "OC Binary:       {{ use_oc_bin }}"
      - "Test Parameters:"
      - "  - Number of VMs to clone: {{ num_vms }}"
      - "  - Timeout: Infinite (press Ctrl+C to interrupt)"
      - "  - Sampling: Every 1 minute"
      - "========================================================================"
  tags: perf-test

- name: Get current cluster server
  ansible.builtin.shell: |
    {% if use_kubeconfig %}export KUBECONFIG="{{ use_kubeconfig }}"{% endif %}
    {{ use_oc_bin }} whoami --show-server
  register: cluster_server
  changed_when: false
  tags: perf-test

- name: Get current authenticated user
  ansible.builtin.shell: |
    {% if use_kubeconfig %}export KUBECONFIG="{{ use_kubeconfig }}"{% endif %}
    {{ use_oc_bin }} whoami
  register: cluster_user
  changed_when: false
  tags: perf-test

- name: Get current context
  ansible.builtin.shell: |
    {% if use_kubeconfig %}export KUBECONFIG="{{ use_kubeconfig }}"{% endif %}
    {{ use_oc_bin }} config current-context
  register: cluster_context
  changed_when: false
  tags: perf-test

- name: Display connection information
  ansible.builtin.debug:
    msg:
      - "Connection Details:"
      - "  - Server:  {{ cluster_server.stdout }}"
      - "  - User:    {{ cluster_user.stdout }}"
      - "  - Context: {{ cluster_context.stdout }}"
      - ""
      - "Starting test in 30 seconds... (Press Ctrl+C to abort)"
  tags: perf-test

- name: Pause for user review
  ansible.builtin.pause:
    seconds: 30
  tags: perf-test

- name: Create test-vms namespace
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_param }}"
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: test-vms
  tags: perf-test

- name: Deploy source VM (vm-cirros-1)
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_param }}"
    state: present
    definition: "{{ lookup('file', '../../templates/veritas/perf-test-source-vm.yaml') | from_yaml }}"
  tags: perf-test

- name: Wait for source VM DataVolume to be ready
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig_param }}"
    api_version: cdi.kubevirt.io/v1beta1
    kind: DataVolume
    namespace: test-vms
    name: cirros-dv-1
  register: source_dv
  retries: 60
  delay: 10
  until:
    - source_dv.resources | length > 0
    - source_dv.resources[0].status.phase is defined
    - source_dv.resources[0].status.phase == "Succeeded"
  tags: perf-test

- name: Display source VM ready message
  ansible.builtin.debug:
    msg: "Source VM DataVolume is ready. Stopping VM before cloning..."
  tags: perf-test

- name: Stop source VM
  ansible.builtin.shell: |
    {% if use_kubeconfig %}export KUBECONFIG="{{ use_kubeconfig }}"{% endif %}
    {{ virtctl_bin_path }} -n test-vms stop vm-cirros-1
  register: stop_vm
  failed_when:
    - stop_vm.rc != 0
    - "'VM is not running' not in stop_vm.stderr"
  tags: perf-test

- name: Wait a moment for VM to stop
  ansible.builtin.pause:
    seconds: 5
  tags: perf-test

- name: Record test start time
  ansible.builtin.shell: date +%s
  register: start_time_output
  changed_when: false
  tags: perf-test

- name: Set test start time fact
  ansible.builtin.set_fact:
    test_start_time: "{{ start_time_output.stdout | int }}"
  tags: perf-test

- name: Create clone VMs
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_param }}"
    state: present
    definition: "{{ lookup('template', '../../templates/veritas/perf-test-clone-vm.yaml.j2') | from_yaml }}"
  loop: "{{ range(2, num_vms | int + 2) | list }}"
  loop_control:
    loop_var: vm_number
    label: "vm-cirros-{{ vm_number }}"
  tags: perf-test

- name: Display VM creation complete
  ansible.builtin.debug:
    msg: "Created {{ num_vms }} clone VMs. Starting PVC monitoring..."
  tags: perf-test

- name: Display monitoring instructions
  ansible.builtin.debug:
    msg:
      - ""
      - "========================================================================"
      - "  To view live VM provisioning status, open another terminal and run:"
      - ""
      - "    watch -n 1 cat /tmp/veritas-vm-provisioning-status.log"
      - ""
      - "  (Updates every second with fresh display)"
      - "========================================================================"
      - ""
  tags: perf-test

- name: Run monitoring with Ctrl+C handling
  block:
    - name: Start background monitoring script with time-series data collection
      ansible.builtin.script: "monitor-vms.sh {{ use_oc_bin }} {{ test_start_time }} {{ num_vms }} {{ results_dir }}"
      args:
        chdir: "{{ playbook_dir }}"
      environment:
        KUBECONFIG: "{{ kubeconfig_param }}"
      register: monitoring_result
      failed_when: monitoring_result.rc not in [0, 2]
  
  rescue:
    - name: Handle Ctrl+C interruption
      ansible.builtin.debug:
        msg: "Test interrupted by Ctrl+C - generating partial report..."
    
    - name: Get current VM counts after interruption
      ansible.builtin.shell: |
        {{ use_oc_bin }} get vms -n test-vms -o json 2>/dev/null | jq '[.items[] | select(.status.printableStatus == "Running")] | length'
      environment:
        KUBECONFIG: "{{ kubeconfig_param }}"
      register: interrupted_vm_count
      failed_when: false
    
    - name: Set interrupted test status
      ansible.builtin.set_fact:
        monitoring_result:
          rc: 2
          failed: false
      
    - name: Write interrupted test result
      ansible.builtin.copy:
        content: "PARTIAL:{{ interrupted_vm_count.stdout | default('0') }}"
        dest: /tmp/veritas-test-result.txt
  tags: perf-test

- name: Get test end time
  ansible.builtin.shell: date +%s
  register: end_time_output
  changed_when: false
  tags: perf-test

- name: Calculate test duration
  ansible.builtin.set_fact:
    test_end_time: "{{ end_time_output.stdout | int }}"
    test_duration: "{{ (end_time_output.stdout | int) - (test_start_time | int) }}"
  tags: perf-test

- name: Read test result file
  ansible.builtin.shell: cat /tmp/veritas-test-result.txt
  register: test_result_raw
  changed_when: false
  failed_when: false
  tags: perf-test

- name: Parse test result
  ansible.builtin.set_fact:
    test_status: "{{ test_result_raw.stdout.split(':')[0] if test_result_raw.rc == 0 else 'FAILED' }}"
    actual_vms_running: "{{ test_result_raw.stdout.split(':')[1] | int if test_result_raw.rc == 0 else 0 }}"
  tags: perf-test

- name: Calculate average provisioning time per VM
  ansible.builtin.set_fact:
    avg_provisioning_time: "{{ (test_duration | int / (actual_vms_running | int)) | round(2) if actual_vms_running | int > 0 else 0 }}"
    success_rate_percent: "{{ ((actual_vms_running | int) / (num_vms | int) * 100) | round(1) }}"
  tags: perf-test

- name: Gather cluster node information for report
  ansible.builtin.shell: |
    {% if use_kubeconfig %}export KUBECONFIG="{{ use_kubeconfig }}"{% endif %}
    {{ use_oc_bin }} get nodes -l node-role.kubernetes.io/worker -o json | jq -r '
      .items[0] as $node |
      "\($node.status.capacity.cpu)|\($node.status.capacity.memory)|\($node.status.capacity.pods)|\($node.metadata.labels["node.kubernetes.io/instance-type"])|\(.items | length)"
    '
  register: node_info
  changed_when: false
  when: monitoring_result.rc in [0, 2]
  tags: perf-test

- name: Get InfoScale cluster details
  ansible.builtin.shell: |
    {% if use_kubeconfig %}export KUBECONFIG="{{ use_kubeconfig }}"{% endif %}
    {{ use_oc_bin }} get infoscalecluster -n infoscale-vtas infoscalecluster-dev -o json 2>/dev/null | jq -r '
      "\(.spec.version)|\(.status.phase // "N/A")|\(.status.clusterState // "N/A")|\((.status.diskgroups // []) | length)|\(.status.diskgroups[0].Name // "N/A")|\(.status.diskgroups[0].TotalSize // "N/A")|\((.status.diskgroups[0].diskInfo // []) | length)"
    '
  register: infoscale_info
  changed_when: false
  failed_when: false
  when: monitoring_result.rc in [0, 2]
  tags: perf-test

- name: Get InfoScale disk details
  ansible.builtin.shell: |
    {% if use_kubeconfig %}export KUBECONFIG="{{ use_kubeconfig }}"{% endif %}
    {{ use_oc_bin }} get infoscalecluster -n infoscale-vtas infoscalecluster-dev -o json 2>/dev/null | jq -r '
      .status.diskgroups[0].diskInfo[] | "\(.diskName)|\(.lunSize)|\(.mediaType)"
    '
  register: disk_info
  changed_when: false
  failed_when: false
  when: monitoring_result.rc in [0, 2]
  tags: perf-test

- name: Get worker node count
  ansible.builtin.shell: |
    {% if use_kubeconfig %}export KUBECONFIG="{{ use_kubeconfig }}"{% endif %}
    {{ use_oc_bin }} get nodes -l node-role.kubernetes.io/worker --no-headers | wc -l
  register: worker_count
  changed_when: false
  when: monitoring_result.rc in [0, 2]
  tags: perf-test

- name: Get storage backend information
  ansible.builtin.shell: |
    {% if use_kubeconfig %}export KUBECONFIG="{{ use_kubeconfig }}"{% endif %}
    {{ use_oc_bin }} get storageclass infoscale -o json 2>/dev/null | jq -r '
      "\(.provisioner)|\(.parameters.fstype // "N/A")|\(.allowVolumeExpansion)|\(.reclaimPolicy)"
    '
  register: storage_info
  changed_when: false
  failed_when: false
  when: monitoring_result.rc in [0, 2]
  tags: perf-test

- name: Parse cluster information
  ansible.builtin.set_fact:
    node_cpu: "{{ node_info.stdout.split('|')[0] }}"
    node_memory_ki: "{{ node_info.stdout.split('|')[1] }}"
    node_memory_gb: "{{ (node_info.stdout.split('|')[1] | regex_replace('Ki', '') | int / 1024 / 1024) | round(0) | int }}"
    node_max_pods: "{{ node_info.stdout.split('|')[2] }}"
    node_instance_type: "{{ node_info.stdout.split('|')[3] }}"
    worker_node_count: "{{ worker_count.stdout | int }}"
    infoscale_version: "{{ infoscale_info.stdout.split('|')[0] | default('9.1.0') }}"
    infoscale_phase: "{{ infoscale_info.stdout.split('|')[1] | default('N/A') }}"
    infoscale_state: "{{ infoscale_info.stdout.split('|')[2] | default('N/A') }}"
    infoscale_diskgroups: "{{ infoscale_info.stdout.split('|')[3] | default('N/A') }}"
    infoscale_dg_name: "{{ infoscale_info.stdout.split('|')[4] | default('N/A') }}"
    infoscale_dg_size: "{{ infoscale_info.stdout.split('|')[5] | default('N/A') }}"
    infoscale_disk_count: "{{ infoscale_info.stdout.split('|')[6] | default('N/A') }}"
    disk_details: "{{ disk_info.stdout_lines | default([]) }}"
    storage_provisioner: "{{ storage_info.stdout.split('|')[0] | default('org.veritas.infoscale') }}"
    storage_fstype: "{{ storage_info.stdout.split('|')[1] | default('vxfs') }}"
    storage_expansion: "{{ storage_info.stdout.split('|')[2] | default('true') }}"
    storage_reclaim: "{{ storage_info.stdout.split('|')[3] | default('Delete') }}"
  when: monitoring_result.rc in [0, 2]
  tags: perf-test

- name: Calculate capacity metrics
  ansible.builtin.set_fact:
    total_cpu_cores: "{{ (node_cpu | int) * (worker_node_count | int) }}"
    total_memory_gb: "{{ (node_memory_gb | int) * (worker_node_count | int) }}"
    total_max_pods: "{{ (node_max_pods | int) * (worker_node_count | int) }}"
    test_cpu_used: "{{ ((num_vms | int) * 0.1) | round(1) }}"
    test_memory_used: "{{ ((num_vms | int) * 0.128) | round(1) }}"
    test_pods_used: "{{ num_vms | int }}"
    cluster_vm_capacity: "{{ ((node_max_pods | int) * (worker_node_count | int) * 0.8) | round(0) | int }}"
    cpu_usage_pct: "{{ (((num_vms | int) * 0.1) / ((node_cpu | int) * (worker_node_count | int)) * 100) | round(1) }}"
    memory_usage_pct: "{{ (((num_vms | int) * 0.128) / ((node_memory_gb | int) * (worker_node_count | int)) * 100) | round(1) }}"
    capacity_usage_pct: "{{ ((num_vms | int) / (((node_max_pods | int) * (worker_node_count | int)) * 0.8) * 100) | round(1) }}"
  when: monitoring_result.rc in [0, 2]
  tags: perf-test

- name: Build disk details string
  ansible.builtin.set_fact:
    disk_details_str: "{{ disk_details_str | default('') + '      ‚Ä¢ ' + item.split('|')[0] + ': ' + item.split('|')[1] + ' (' + item.split('|')[2] + ')\n' }}"
  loop: "{{ disk_details }}"
  when: monitoring_result.rc in [0, 2]
  tags: perf-test

- name: Get current timestamp for report
  ansible.builtin.shell: date -u '+%Y-%m-%d %H:%M:%S UTC'
  register: report_timestamp
  changed_when: false
  when: monitoring_result.rc in [0, 2]
  tags: perf-test

- name: Generate summary CSV file
  ansible.builtin.copy:
    content: |
      num_vms_requested,num_vms_running,duration_seconds,avg_seconds_per_vm,success_rate_percent,test_status
      {{ num_vms }},{{ actual_vms_running }},{{ test_duration }},{{ avg_provisioning_time }},{{ success_rate_percent }},{{ test_status }}
    dest: "{{ results_dir }}/veritas-9.1-ga-perf-test-{{ num_vms }}vms.csv"
  when: monitoring_result.rc in [0, 2]
  tags: perf-test

- name: Generate cluster information text file
  ansible.builtin.copy:
    content: |
      ========================================================================
      VERITAS INFOSCALE 9.1 GA - PERFORMANCE TEST CLUSTER INFORMATION
      OCPNAS-312 Concurrency Validation
      ========================================================================
      
      TEST EXECUTION INFORMATION
      ------------------------------------------------------------------------
      Test Date:               {{ report_timestamp.stdout }}
      Test Status:             {{ test_status }}
      VMs Requested:           {{ num_vms }}
      VMs Successfully Running:{{ actual_vms_running }}
      Success Rate:            {{ success_rate_percent }}%
      Total Duration:          {{ test_duration }}s ({{ (test_duration | int / 60) | round(1) }} minutes)
      Avg Time per VM:         {{ avg_provisioning_time }}s
      
      OPENSHIFT CLUSTER CONFIGURATION
      ------------------------------------------------------------------------
      API Server:              {{ cluster_server.stdout }}
      
      Worker Nodes:            {{ worker_node_count }}
      Instance Type:           {{ node_instance_type }}
      vCPU per Node:           {{ node_cpu }} cores
      Memory per Node:         {{ node_memory_gb }} GB
      Max Pods per Node:       {{ node_max_pods }}
      
      Total Cluster Resources:
        - Total vCPU:          {{ total_cpu_cores }} cores
        - Total Memory:        {{ total_memory_gb }} GB
        - Total Pod Capacity:  {{ total_max_pods }} pods
      
      VERITAS INFOSCALE STORAGE CONFIGURATION
      ------------------------------------------------------------------------
      InfoScale Version:       {{ infoscale_version }}
      Cluster State:           {{ infoscale_state }}
      Cluster Phase:           {{ infoscale_phase }}
      Disk Groups:             {{ infoscale_diskgroups }}
      
      Storage Class Configuration:
        - Name:                infoscale (default)
        - Provisioner:         {{ storage_provisioner }}
        - Filesystem Type:     {{ storage_fstype }} (Veritas VxFS)
        - Volume Expansion:    {{ storage_expansion }}
        - Reclaim Policy:      {{ storage_reclaim }}
        - Binding Mode:        Immediate
      
      InfoScale Storage Pool:
        - Disk Group Name:     {{ infoscale_dg_name }}
        - Total Pool Size:     {{ infoscale_dg_size }}
        - Number of Disks:     {{ infoscale_disk_count }}
        - Media Type:          SSD (NVMe)
        - Disk Details:
      {{ disk_details_str | default('          (No disk details available)') }}
      
      InfoScale Features:
        - Encryption:          Disabled
        - SCSI-3 PR:           Enabled
        - Shared Storage:      Enabled
      
      RESOURCE UTILIZATION ANALYSIS
      ------------------------------------------------------------------------
      Test Resource Consumption:
        - vCPU Used:           ~{{ test_cpu_used }} cores ({{ cpu_usage_pct }}% of cluster)
        - Memory Used:         ~{{ test_memory_used }} GB ({{ memory_usage_pct }}% of cluster)
        - Pods Used:           {{ test_pods_used }} ({{ capacity_usage_pct }}% of capacity)
        - Storage Used:        {{ num_vms | int }} GB (InfoScale managed)
      
      Cluster Capacity Assessment:
        - Estimated Max VMs:   ~{{ cluster_vm_capacity }} VMs
        - Limiting Factor:     Pod capacity ({{ node_max_pods }} pods/node)
        - Current Test:        {{ capacity_usage_pct }}% of max capacity
        - Remaining Capacity:  {{ (cluster_vm_capacity | int) - (num_vms | int) }} VMs
      
      VM SPECIFICATIONS
      ------------------------------------------------------------------------
        - Image:               Cirros (lightweight test image)
        - Memory per VM:       128 MiB
        - Storage per VM:      1 GiB (InfoScale vxfs)
        - Access Mode:         ReadWriteMany
        - Clone Method:        PVC-to-PVC copy (DataVolume)
      
      TEST PARAMETERS
      ------------------------------------------------------------------------
        - Timeout:             Infinite (user interrupt with Ctrl+C)
        - Sampling Interval:   Every 1 minute
        - Time-series File:    veritas-9.1-ga-perf-test-summary-timeseries.csv
    dest: "{{ results_dir }}/veritas-9.1-ga-perf-test-{{ num_vms }}vms-cluster-info.txt"
  when: monitoring_result.rc in [0, 2]
  tags: perf-test

- name: Display comprehensive stakeholder report
  ansible.builtin.debug:
    msg:
      - ""
      - "========================================================================"
      - "     VERITAS INFOSCALE CSI PERFORMANCE TEST REPORT"
      - "     OCPNAS-312 Concurrency Validation"
      - "========================================================================"
      - ""
      - "TEST RESULT: {{ '‚úì PASSED' if test_status == 'SUCCESS' else '‚óê PARTIAL (User Interrupted)' }}"
      - ""
      - "EXECUTIVE SUMMARY:"
      - "{% if test_status == 'SUCCESS' %}  Successfully provisioned and validated {{ num_vms }} VMs using Veritas{% else %}  Provisioned {{ actual_vms_running }}/{{ num_vms }} VMs before user interruption using Veritas{% endif %}"
      - "  InfoScale {{ infoscale_version }} as the CSI storage provider.{% if test_status == 'SUCCESS' %} All VMs achieved{% else %} {{ actual_vms_running }} VMs achieved{% endif %}"
      - "  Running state{% if test_status == 'SUCCESS' %} with no provisioning failures or performance issues.{% else %} before test was interrupted.{% endif %}"
      - ""
      - "========================================================================"
      - "OPENSHIFT CLUSTER CONFIGURATION"
      - "========================================================================"
      - "  Worker Nodes:          {{ worker_node_count }}"
      - "  Instance Type:         {{ node_instance_type }}"
      - "  vCPU per Node:         {{ node_cpu }} cores"
      - "  Memory per Node:       {{ node_memory_gb }} GB"
      - "  Max Pods per Node:     {{ node_max_pods }}"
      - ""
      - "  Total Cluster Resources:"
      - "    - Total vCPU:        {{ total_cpu_cores }} cores"
      - "    - Total Memory:      {{ total_memory_gb }} GB"
      - "    - Total Pod Capacity:{{ total_max_pods }} pods"
      - ""
      - "========================================================================"
      - "VERITAS INFOSCALE STORAGE CONFIGURATION"
      - "========================================================================"
      - "  InfoScale Version:     {{ infoscale_version }}"
      - "  Cluster State:         {{ infoscale_state }}"
      - "  Cluster Phase:         {{ infoscale_phase }}"
      - "  Disk Groups:           {{ infoscale_diskgroups }}"
      - ""
      - "  Storage Class Configuration:"
      - "    - Name:              infoscale (default)"
      - "    - Provisioner:       {{ storage_provisioner }}"
      - "    - Filesystem Type:   {{ storage_fstype }} (Veritas VxFS)"
      - "    - Volume Expansion:  {{ storage_expansion }}"
      - "    - Reclaim Policy:    {{ storage_reclaim }}"
      - "    - Binding Mode:      Immediate"
      - ""
      - "  InfoScale Storage Pool:"
      - "    - Disk Group Name:   {{ infoscale_dg_name }}"
      - "    - Total Pool Size:   {{ infoscale_dg_size }}"
      - "    - Number of Disks:   {{ infoscale_disk_count }}"
      - "    - Media Type:        SSD (NVMe)"
      - "    - Disk Details:"
      - "{{ disk_details_str }}"
      - ""
      - "  InfoScale Features:"
      - "    - Encryption:        Disabled"
      - "    - SCSI-3 PR:         Enabled"
      - "    - Shared Storage:    Enabled"
      - ""
      - "========================================================================"
      - "TEST EXECUTION DETAILS"
      - "========================================================================"
      - "  VMs Requested:         {{ num_vms }}"
      - "  VMs Successfully Running: {{ actual_vms_running }}"
      - "  Success Rate:          {{ success_rate_percent }}%"
      - "  Total Duration:        {{ test_duration }}s ({{ (test_duration | int / 60) | round(1) }} minutes)"
      - "  Avg Time per VM:       {{ avg_provisioning_time }}s"
      - ""
      - "  VM Specifications:"
      - "    - Image:             Cirros (lightweight test image)"
      - "    - Memory per VM:     128 MiB"
      - "    - Storage per VM:    1 GiB (InfoScale vxfs)"
      - "    - Access Mode:       ReadWriteMany"
      - "    - Clone Method:      PVC-to-PVC copy (DataVolume)"
      - ""
      - "========================================================================"
      - "RESOURCE UTILIZATION ANALYSIS"
      - "========================================================================"
      - "  Test Resource Consumption:"
      - "    - vCPU Used:         ~{{ test_cpu_used }} cores ({{ cpu_usage_pct }}% of cluster)"
      - "    - Memory Used:       ~{{ test_memory_used }} GB ({{ memory_usage_pct }}% of cluster)"
      - "    - Pods Used:         {{ test_pods_used }} ({{ capacity_usage_pct }}% of capacity)"
      - "    - Storage Used:      {{ num_vms | int }} GB (InfoScale managed)"
      - ""
      - "  Cluster Capacity Assessment:"
      - "    - Estimated Max VMs: ~{{ cluster_vm_capacity }} VMs"
      - "    - Limiting Factor:   Pod capacity ({{ node_max_pods }} pods/node)"
      - "    - Current Test:      {{ capacity_usage_pct }}% of max capacity"
      - "    - Remaining Capacity:{{ (cluster_vm_capacity | int) - (num_vms | int) }} VMs"
      - ""
      - "========================================================================"
      - "PERFORMANCE OBSERVATIONS"
      - "========================================================================"
      - "{% if test_status == 'SUCCESS' %}  ‚úì No PVC provisioning failures{% else %}  ‚óê Test interrupted by user{% endif %}"
      - "{% if test_status == 'SUCCESS' %}  ‚úì No volume binding timeouts{% else %}  ‚óê {{ actual_vms_running }}/{{ num_vms }} VMs reached Running state{% endif %}"
      - "{% if test_status == 'SUCCESS' %}  ‚úì No storage backend errors{% else %}  ‚óê No errors observed before interruption{% endif %}"
      - "{% if test_status == 'SUCCESS' %}  ‚úì All VMs transitioned to Running state successfully{% else %}  ‚óê Remaining VMs may still be provisioning{% endif %}"
      - "  ‚úì Average provisioning time: {{ avg_provisioning_time }}s per VM"
      - ""
      - "========================================================================"
      - "{% if test_status == 'SUCCESS' %}Cleaning up test resources...{% else %}Test resources preserved in 'test-vms' namespace for inspection.{% endif %}"
  when: monitoring_result.rc in [0, 2]
  tags: perf-test

- name: Cleanup test resources on success
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_param }}"
    state: absent
    api_version: v1
    kind: Namespace
    name: test-vms
    wait: yes
    wait_timeout: 300
  when: test_status == 'SUCCESS'
  tags: perf-test

- name: Display cleanup complete message
  ansible.builtin.debug:
    msg: "‚úì Cleanup complete - test-vms namespace deleted"
  when: test_status == 'SUCCESS'
  tags: perf-test

- name: Display partial test summary
  ansible.builtin.debug:
    msg:
      - ""
      - "========================================================================"
      - "                    TEST INTERRUPTED ‚óê"
      - "========================================================================"
      - "Test Summary:"
      - "  - Target VMs:        {{ num_vms }}"
      - "  - VMs Running:       {{ actual_vms_running }}"
      - "  - Success Rate:      {{ success_rate_percent }}%"
      - "  - Test duration:     {{ test_duration }}s ({{ (test_duration | int / 60) | round(1) }} minutes)"
      - ""
      - "Resources preserved in 'test-vms' namespace for inspection."
      - "To check status: {{ use_oc_bin }} get vms -n test-vms"
      - "To cleanup manually: {{ use_oc_bin }} delete namespace test-vms"
      - "========================================================================"
  when: test_status == 'PARTIAL'
  tags: perf-test

- name: Display failure summary
  ansible.builtin.debug:
    msg:
      - ""
      - "========================================================================"
      - "                    TEST FAILED ‚úó"
      - "========================================================================"
      - "Test Summary:"
      - "  - Target VMs: {{ num_vms }}"
      - "  - Test duration: {{ test_duration }}s"
      - ""
      - "Resources preserved in 'test-vms' namespace for debugging."
      - "To check status: {{ use_oc_bin }} get vms -n test-vms"
      - "To cleanup manually: {{ use_oc_bin }} delete namespace test-vms"
      - "========================================================================"
  when: monitoring_result.rc not in [0, 2]
  tags: perf-test
