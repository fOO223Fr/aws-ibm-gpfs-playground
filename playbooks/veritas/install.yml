- name: Install InfoScale Operator
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition: "{{ lookup('file', '../../templates/veritas/infoscale-operator.yaml') | from_yaml_all }}"

- name: Wait for Veritas License CRD to be available
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig }}"
    api_version: vlic.veritas.com/v1
    kind: License
  register: veritas_license_check
  retries: 30
  delay: 10
  until: veritas_license_check.failed is not defined or not veritas_license_check.failed
  changed_when: false

- name: Create Veritas License
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition: "{{ lookup('file', '../../templates/veritas/license.yaml') }}"
  register: veritas_license_result
  retries: 30
  delay: 10
  until: veritas_license_result is succeeded

- name: Get worker nodes
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig }}"
    kind: Node
    label_selectors:
      - "node-role.kubernetes.io/worker"
  register: worker_nodes_info

- name: Set worker node names
  set_fact:
    worker_nodes_name_list: >-
      {{ worker_nodes_info.resources | map(attribute='metadata.name') | list }}

- name: Auto-detect available disks on first worker node (if not specified)
  ansible.builtin.shell: |
    export KUBECONFIG="{{ kubeconfig }}"
    oc debug node/{{ worker_nodes_name_list | first }} -- chroot /host bash -c '
    # Get boot disk to exclude
    boot_partition=$(findmnt -n -o SOURCE /boot 2>/dev/null || findmnt -n -o SOURCE /)
    boot_disk=$(lsblk -ndo PKNAME "$boot_partition" 2>/dev/null || echo "$boot_partition" | sed "s/p\?[0-9]*$//")
    [[ "$boot_disk" =~ ^/dev/ ]] || boot_disk="/dev/$boot_disk"
    
    # Find all nvme devices (excluding boot disk)
    for nvme_dev in /dev/nvme[0-9]n[0-9]; do
      [ -b "$nvme_dev" ] || continue
      
      # Skip if boot disk
      real_dev=$(readlink -f "$nvme_dev")
      [ "$real_dev" == "$boot_disk" ] && continue
      
      # Get by-path
      by_path=$(ls -l /dev/disk/by-path/ | grep "$(basename $nvme_dev)\$" | awk "{print \$9}" | head -1)
      
      if [ -n "$by_path" ]; then
        echo "/dev/disk/by-path/$by_path"
      fi
    done
    '
  register: detected_disks_raw
  changed_when: false
  when: infoscale_include_devices is not defined

- name: Set auto-detected disks
  ansible.builtin.set_fact:
    infoscale_include_devices: "{{ detected_disks_raw.stdout_lines | select('match', '^/dev/disk/by-path/') | list }}"
  when: infoscale_include_devices is not defined

- name: Display detected disks for InfoScale
  ansible.builtin.debug:
    msg:
      - "========================================================================"
      - "Auto-detected disks for InfoScale cluster:"
      - "{% for device in infoscale_include_devices %}  - {{ device }}{% endfor %}"
      - ""
      - "Total: {{ infoscale_include_devices | length }} disk(s)"
      - "========================================================================"
  when: infoscale_include_devices | length > 0

- name: Deploy InfoScaleCluster
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition: "{{ lookup('template', '../../templates/veritas/infoscale-cluster.yaml.j2') }}"
  register: infoscale_cluster_result
  retries: 10
  delay: 5
  until: infoscale_cluster_result is succeeded

# Assuming that the default StorageClass is gp3-csi
- name: Ensure gp3-csi StorageClass is not default
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    api_version: storage.k8s.io/v1
    kind: StorageClass
    name: gp3-csi
    definition:
      metadata:
        annotations:
          storageclass.kubernetes.io/is-default-class: "false"
    merge_type: merge

- name: Create InfoScale StorageClass as default
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition: "{{ lookup('file', '../../templates/veritas/storageclass.yaml') }}"

- name: Create VolumeSnapshotClass
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition: "{{ lookup('file', '../../templates/veritas/snapshotclass.yaml') }}"

- name: Patch StorageProfile (accessModes and cloneStrategy)
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    api_version: cdi.kubevirt.io/v1beta1
    kind: StorageProfile
    name: infoscale
    definition:
      spec:
        claimPropertySets:
          - accessModes: ["ReadWriteOnce"]
            volumeMode: "Filesystem"
        cloneStrategy: csi-clone
    merge_type: merge
